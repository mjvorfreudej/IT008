using System;
using System.Data.SqlClient;
using System.Globalization;
using System.Windows.Forms;

namespace Bai05
{
    public partial class AddStudentForm : Form
    {
        private readonly string _connectionString;

        public AddStudentForm(string connectionString)
        {
            InitializeComponent();
            _connectionString = connectionString;
        }

        private void AddStudentForm_Load(object sender, EventArgs e)
        {
            if (cboKhoa.Items.Count == 0)
            {
                cboKhoa.Items.Add("Công nghệ thông tin");
                cboKhoa.Items.Add("Kinh tế");
                cboKhoa.Items.Add("Ngôn ngữ Anh");
            }
            cboKhoa.SelectedIndex = 0;
        }

        private void btnThemMoi_Click(object sender, EventArgs e)
        {
            if (!ValidateInput()) return;

            string maSV = txtMaSV.Text.Trim();
            string tenSV = txtTenSV.Text.Trim();
            string khoa = cboKhoa.Text.Trim();
            double diemTB = double.Parse(txtDiemTB.Text.Trim(), CultureInfo.InvariantCulture);

            using (SqlConnection conn = new SqlConnection(_connectionString))
            using (SqlCommand cmd = conn.CreateCommand())
            {
                cmd.CommandText = @"INSERT INTO SinhVien(MaSV, TenSV, Khoa, DiemTB)
                                    VALUES (@MaSV, @TenSV, @Khoa, @DiemTB)";
                cmd.Parameters.AddWithValue("@MaSV", maSV);
                cmd.Parameters.AddWithValue("@TenSV", tenSV);
                cmd.Parameters.AddWithValue("@Khoa", khoa);
                cmd.Parameters.AddWithValue("@DiemTB", diemTB);

                try
                {
                    conn.Open();
                    cmd.ExecuteNonQuery();
                    MessageBox.Show("Thêm sinh viên thành công!", "Thông báo",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);

                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                catch (SqlException ex)
                {
                    if (ex.Number == 2627)
                        MessageBox.Show("Mã sinh viên đã tồn tại!", "Lỗi",
                            MessageBoxButtons.OK, MessageBoxIcon.Error);
                    else
                        MessageBox.Show("Lỗi khi thêm sinh viên:\n" + ex.Message, "Lỗi",
                            MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private bool ValidateInput()
        {
            if (string.IsNullOrWhiteSpace(txtMaSV.Text))
            {
                MessageBox.Show("Mã số sinh viên không được rỗng.");
                txtMaSV.Focus();
                return false;
            }
            if (string.IsNullOrWhiteSpace(txtTenSV.Text))
            {
                MessageBox.Show("Tên sinh viên không được rỗng.");
                txtTenSV.Focus();
                return false;
            }
            if (string.IsNullOrWhiteSpace(cboKhoa.Text))
            {
                MessageBox.Show("Vui lòng chọn khoa.");
                cboKhoa.Focus();
                return false;
            }
            if (!double.TryParse(txtDiemTB.Text.Trim(), NumberStyles.Any,
                    CultureInfo.InvariantCulture, out double d) || d < 0 || d > 10)
            {
                MessageBox.Show("Điểm TB phải là số từ 0 đến 10.");
                txtDiemTB.Focus();
                return false;
            }
            return true;
        }

        private void btnThoat_Click(object sender, EventArgs e)
        {
            this.Close();
        }
    }
}
